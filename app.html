<!doctype html>
<html lang="en">

<head>
	<title>Jaysee: yet another JSON visualizer</title>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="description" content="Yet another JSON visualizer">
	<meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
	<meta name="theme-color" content="#5e35b1">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<meta name="apple-mobile-web-app-title" content="Jaysee">
	<meta name="application-name" content="Jaysee">
	<link rel="apple-touch-icon" sizes="57x57" href="images/apple-icon-57x57.png">
	<link rel="apple-touch-icon" sizes="60x60" href="images/apple-icon-60x60.png">
	<link rel="apple-touch-icon" sizes="72x72" href="images/apple-icon-72x72.png">
	<link rel="apple-touch-icon" sizes="76x76" href="images/apple-icon-76x76.png">
	<link rel="apple-touch-icon" sizes="114x114" href="images/apple-icon-114x114.png">
	<link rel="apple-touch-icon" sizes="120x120" href="images/apple-icon-120x120.png">
	<link rel="apple-touch-icon" sizes="144x144" href="images/apple-icon-144x144.png">
	<link rel="apple-touch-icon" sizes="152x152" href="images/apple-icon-152x152.png">
	<link rel="apple-touch-icon" sizes="180x180" href="images/apple-icon-180x180.png">
	<link rel="apple-touch-icon-precomposed" href="images/apple-icon-180x180.png">
	<link rel="icon" type="image/png" sizes="192x192" href="images/android-icon-192x192.png">
	<link rel="icon" type="image/png" sizes="32x32" href="images/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="96x96" href="images/favicon-96x96.png">
	<link rel="icon" type="image/png" sizes="16x16" href="images/favicon-16x16.png">
	<link rel="manifest" href="manifest.json">
	<style type="text/css">
		#layout {
			transition: opacity 0.3s;
			opacity: 0;
		}
	</style>
	<script>
		/*global ga*/
		(function(i, s, o, g, r, a, m) {
			i['GoogleAnalyticsObject'] = r;
			i[r] = i[r] || function() {
				(i[r].q = i[r].q || []).push(arguments);
			}, i[r].l = 1 * new Date();
			a = s.createElement(o),
				m = s.getElementsByTagName(o)[0];
			a.async = 1;
			a.src = g;
			m.parentNode.insertBefore(a, m);
		})(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
		ga('create', 'UA-19223409-5', 'auto');
		ga('send', 'pageview');
	</script>
</head>

<body>
	<div id="layout">
		<header>
	    	<section id="section-brand">
	    		<a href="/">
	    			<img src="images/android-icon-48x48.png" />
	    		</a>
	    	</section>
	    	<section id="section-source">
				<input type="text" placeholder="Enter API URL here ..." spellcheck="false" id="item-source" :value="source" @keyup.13="load">
				<button class="button" id="item-source" @click="load">
					<i class="material-icons">refresh</i>
				</button>
			</section>
		</header>
		<main></main>
		<progress id="progress" v-show="!this.loaded"></progress>
	</div>
	<script src="library/loader.js"></script>
	<script>/* global Loader, Butter, Vue, d3 */

		Loader.inject([
			'https://fonts.googleapis.com/css?family=Roboto:300,400,500,700',
			'https://fonts.googleapis.com/icon?family=Material+Icons',
			'https://cdnjs.cloudflare.com/ajax/libs/vue/2.1.8/vue.min.js',
			'https://d3js.org/d3.v4.min.js', //FIXME minify.
			'library/butter.js',
			'app.css'
		], start);

		function start() {
			let parameter = Butter.queryToObject(window.location.search);

			setInterval(function() {
				document.querySelector('#layout').style.opacity = '1'; // Prevents FOUC due to PageSpeed optimizations.
			});
			new Vue({
				el: '#layout',
				data: {
					source: null,
					loaded: false
				},
				created() {
					if (parameter.call) {
						this.source = decodeURIComponent(parameter.call);
					} else {
						this.loaded = true;
					}
				},
				methods: {
					load() {
						this.source = document.querySelector('#item-source').value;
					}
				},
				watch: {
					source() {
						this.loaded = false;
						d3.select('svg').remove();
						d3.json(`/api?call=${this.source}`, aResponse => {
							window.history.pushState({}, 'Jaysee', `?call=${encodeURIComponent(this.source)}`);
							const container = d3.select('main').append('svg').append('g');
							const data = Butter.objectToKeyValue(!aResponse.data ? aResponse : !aResponse.data.data ? aResponse.data : aResponse.data.data);
							const tree = d3.tree();
							const root = d3.hierarchy(data, (d) => {
								return Array.isArray(d) ? d : d.children;
							});
							this.loaded = true;
							tree.nodeSize([60, 600]);
							// tree.separation((a, b) => a.depth === 0 && b.depth === 0 ? 2 : 1);
							tree(root);
							container.selectAll('.node-path')
								.data(root.descendants())
								.enter()
								.append('path')
									.attr('class', 'node-path')
									.attr('d', (d) => {
										return !d.parent
											? null
											: `M${d.y},${d.x} C${(d.y + d.parent.y)/2},${d.x} ${(d.y + d.parent.y)/2},${d.parent.x} ${d.parent.y},${d.parent.x}`;
									})
							;
							container.selectAll('.node-box')
								.data(root.descendants())
								.enter()
								.append('rect')
									.attr('class', 'node-box')
									.attr('x', d => d.y)
									.attr('y', d => d.x-25)
							;
							container.selectAll('.node-text')
								.data(root.descendants())
								.enter()
								.append('text')
									.attr('class', 'node-text')
									.call((t) => {
										t.append('tspan')
											.attr('x', d => d.y+10)
											.attr('y', d => d.x-5)
											.text((d) => d.data.k || `${d.data.length} items`)
										;
										t.append('tspan')
											.attr('x', d => d.y+10)
											.attr('y', d => d.x+15)
											.text((d) => d.data.v || d.data.v === 0 ? d.data.v : '')
										;
									})
							;
							const z = d3.zoom();
							const t = d3.zoomIdentity.translate(50, window.innerHeight/2).scale(0.7);
							container.attr('transform', t.toString());
							d3.select('svg')
								.append('rect')
									.attr('width',  '100vw')
									.attr('height', '100vh')
									.style('fill', 'none')
									.style('pointer-events', 'all')
									.call(z.transform, t)
									.call(z
										.scaleExtent([0.1, 2])
										.on('zoom', () => {
											container.attr('transform', d3.event.transform);
										})
									)
							;
						});
					}
				}
			});
		}
	</script>
</body>

</html>

